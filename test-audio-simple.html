<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³é¢‘æŒ‰é’®æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
        }
        .test-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .audio-btn {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
        }
        .audio-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #38a169, #2f855a);
        }
        .audio-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        .log {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.9rem;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ”Š éŸ³é¢‘æŒ‰é’®åŠŸèƒ½æµ‹è¯•</h1>

    <div class="test-section">
        <h2>æµ‹è¯•1: ç›´æ¥éŸ³é¢‘æ’­æ”¾</h2>
        <p>æµ‹è¯•åŸºæœ¬çš„è¯­éŸ³åˆæˆåŠŸèƒ½ï¼š</p>
        <button class="audio-btn" onclick="testDirectSpeech()">ç›´æ¥æ’­æ”¾æµ‹è¯•</button>
    </div>

    <div class="test-section">
        <h2>æµ‹è¯•2: æ¨¡æ‹Ÿç³»ç»ŸéŸ³é¢‘æ’­æ”¾</h2>
        <p>ä½¿ç”¨ä¸æµ‹è¯•ç³»ç»Ÿç›¸åŒçš„éŸ³é¢‘æ’­æ”¾æ–¹æ³•ï¼š</p>
        <div id="audioContainer">
            <button class="audio-btn" id="playAudioBtn">ğŸ”Š æ’­æ”¾éŸ³é¢‘</button>
        </div>
    </div>

    <div class="test-section">
        <h2>æµ‹è¯•3: æ¨¡æ‹Ÿå®Œæ•´åˆ›å»ºè¿‡ç¨‹</h2>
        <p>åŠ¨æ€åˆ›å»ºéŸ³é¢‘æŒ‰é’®å¹¶æ·»åŠ äº‹ä»¶ç›‘å¬å™¨ï¼š</p>
        <button class="audio-btn" onclick="createAudioButton()">åˆ›å»ºéŸ³é¢‘æŒ‰é’®</button>
        <div id="dynamicContainer" style="margin-top: 10px;"></div>
    </div>

    <div class="log" id="logOutput">
        <div>æ—¥å¿—è¾“å‡ºï¼š</div>
    </div>

    <script>
        class AudioTestSystem {
            constructor() {
                this.audioQueue = [];
                this.isSpeaking = false;
            }

            log(message) {
                const logOutput = document.getElementById('logOutput');
                const logEntry = document.createElement('div');
                const timestamp = new Date().toLocaleTimeString();
                logEntry.textContent = `[${timestamp}] ${message}`;
                logOutput.appendChild(logEntry);
                logOutput.scrollTop = logOutput.scrollHeight;
                console.log(`[AUDIO-TEST] ${message}`);
            }

            // å¤åˆ¶æµ‹è¯•ç³»ç»Ÿçš„éŸ³é¢‘æ’­æ”¾æ–¹æ³•
            playSentenceAudio(sentence, buttonId = 'playAudioBtn') {
                this.log(`å¼€å§‹æ’­æ”¾å¥å­éŸ³é¢‘: "${sentence}"`);

                if ('speechSynthesis' in window) {
                    this.log('æµè§ˆå™¨æ”¯æŒè¯­éŸ³åˆæˆåŠŸèƒ½');

                    // æ·»åŠ åˆ°éŸ³é¢‘é˜Ÿåˆ—
                    this.addToAudioQueue({
                        type: 'sentence',
                        text: sentence,
                        buttonId: buttonId,
                        rate: 0.9
                    });
                    this.processAudioQueue();
                } else {
                    this.log('âŒ æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åˆæˆåŠŸèƒ½');
                    this.updateAudioButtonState(buttonId, 'ğŸ”‡ ä¸æ”¯æŒéŸ³é¢‘', true, 'error');
                }
            }

            addToAudioQueue(audioItem) {
                this.audioQueue.push(audioItem);
                if (this.audioQueue.length > 5) {
                    this.audioQueue = this.audioQueue.slice(-5);
                }
                this.log(`æ·»åŠ åˆ°éŸ³é¢‘é˜Ÿåˆ—: "${audioItem.text}" (é˜Ÿåˆ—é•¿åº¦: ${this.audioQueue.length})`);
            }

            processAudioQueue() {
                if (this.isSpeaking || this.audioQueue.length === 0) {
                    this.log('æ— æ³•å¤„ç†éŸ³é¢‘é˜Ÿåˆ—: æ­£åœ¨æ’­æ”¾æˆ–é˜Ÿåˆ—ä¸ºç©º');
                    return;
                }

                this.isSpeaking = true;
                const audioItem = this.audioQueue.shift();
                this.log(`å¼€å§‹å¤„ç†éŸ³é¢‘é˜Ÿåˆ—é¡¹ç›®: "${audioItem.text}"`);

                // å–æ¶ˆä¹‹å‰çš„æ’­æ”¾
                window.speechSynthesis.cancel();

                // åˆ›å»ºè¯­éŸ³åˆæˆ
                const utterance = new SpeechSynthesisUtterance(audioItem.text);
                utterance.lang = 'en-US';
                utterance.rate = audioItem.rate;
                utterance.pitch = 1;
                utterance.volume = 1;

                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                if (audioItem.buttonId) {
                    this.updateAudioButtonState(audioItem.buttonId, 'ğŸ”Š æ’­æ”¾ä¸­...', true);
                }

                // æ’­æ”¾å®Œæˆåçš„å¤„ç†
                utterance.onend = () => {
                    this.isSpeaking = false;
                    this.log(`âœ… æ’­æ”¾å®Œæˆ: "${audioItem.text}"`);

                    if (audioItem.buttonId) {
                        this.updateAudioButtonState(audioItem.buttonId, 'ğŸ”Š æ’­æ”¾éŸ³é¢‘', false);
                    }

                    setTimeout(() => {
                        this.processAudioQueue();
                    }, 200);
                };

                // é”™è¯¯å¤„ç†
                utterance.onerror = (event) => {
                    this.log(`âŒ æ’­æ”¾é”™è¯¯: "${audioItem.text}" - ${event.error}`);
                    this.isSpeaking = false;

                    if (audioItem.buttonId) {
                        this.updateAudioButtonState(audioItem.buttonId, 'ğŸ”Š æ’­æ”¾éŸ³é¢‘', false);
                    }

                    setTimeout(() => {
                        this.processAudioQueue();
                    }, 200);
                };

                // å¼€å§‹æ’­æ”¾
                window.speechSynthesis.speak(utterance);
                this.log(`ğŸµ æ­£åœ¨æ’­æ”¾: "${audioItem.text}"`);
            }

            updateAudioButtonState(buttonId, text, disabled, state = 'normal') {
                const audioBtn = document.getElementById(buttonId);
                if (audioBtn) {
                    audioBtn.textContent = text;
                    audioBtn.disabled = disabled;
                    this.log(`æŒ‰é’®çŠ¶æ€æ›´æ–°: ${text} (disabled: ${disabled})`);

                    if (state === 'error') {
                        audioBtn.style.background = 'linear-gradient(135deg, #e53e3e, #c53030)';
                    }
                } else {
                    this.log(`âŒ æ‰¾ä¸åˆ°æŒ‰é’®: ${buttonId}`);
                }
            }
        }

        const audioTest = new AudioTestSystem();

        // æµ‹è¯•1: ç›´æ¥è¯­éŸ³åˆæˆ
        function testDirectSpeech() {
            audioTest.log('=== æµ‹è¯•1: ç›´æ¥è¯­éŸ³åˆæˆ ===');

            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance("Hello, this is a direct speech test.");
                utterance.lang = 'en-US';
                utterance.onend = () => audioTest.log('âœ… ç›´æ¥è¯­éŸ³æ’­æ”¾å®Œæˆ');
                utterance.onerror = (e) => audioTest.log(`âŒ ç›´æ¥è¯­éŸ³é”™è¯¯: ${e.error}`);

                window.speechSynthesis.speak(utterance);
                audioTest.log('ğŸµ å¼€å§‹ç›´æ¥è¯­éŸ³æ’­æ”¾');
            } else {
                audioTest.log('âŒ æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åˆæˆ');
            }
        }

        // æµ‹è¯•2: æ¨¡æ‹Ÿç³»ç»ŸéŸ³é¢‘æ’­æ”¾
        document.addEventListener('DOMContentLoaded', function() {
            const audioBtn = document.getElementById('playAudioBtn');
            if (audioBtn) {
                audioBtn.addEventListener('click', () => {
                    audioTest.log('éŸ³é¢‘æŒ‰é’®è¢«ç‚¹å‡»ï¼');
                    const testSentence = "How long is the Great Wall? It's more than forty thousand li long.";
                    audioTest.playSentenceAudio(testSentence);
                });
                audioTest.log('âœ… éŸ³é¢‘æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨å·²æ·»åŠ ');
            } else {
                audioTest.log('âŒ æ‰¾ä¸åˆ°éŸ³é¢‘æŒ‰é’®');
            }
        });

        // æµ‹è¯•3: åŠ¨æ€åˆ›å»ºéŸ³é¢‘æŒ‰é’®
        function createAudioButton() {
            audioTest.log('=== æµ‹è¯•3: åŠ¨æ€åˆ›å»ºéŸ³é¢‘æŒ‰é’® ===');

            const container = document.getElementById('dynamicContainer');

            // åˆ›å»ºä¸æµ‹è¯•ç³»ç»Ÿç›¸åŒçš„HTMLç»“æ„
            container.innerHTML = `
                <div class="audio-controls">
                    <button class="audio-btn" id="dynamicPlayAudioBtn">
                        ğŸ”Š æ’­æ”¾éŸ³é¢‘
                    </button>
                </div>
            `;

            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            const audioBtn = document.getElementById('dynamicPlayAudioBtn');
            if (audioBtn) {
                audioBtn.addEventListener('click', () => {
                    audioTest.log('åŠ¨æ€åˆ›å»ºçš„éŸ³é¢‘æŒ‰é’®è¢«ç‚¹å‡»ï¼');
                    const testSentence = "This is a dynamically created audio button test.";
                    audioTest.playSentenceAudio(testSentence, 'dynamicPlayAudioBtn');
                });
                audioTest.log('âœ… åŠ¨æ€éŸ³é¢‘æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨å·²æ·»åŠ ');
            } else {
                audioTest.log('âŒ æ‰¾ä¸åˆ°åŠ¨æ€åˆ›å»ºçš„éŸ³é¢‘æŒ‰é’®');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            audioTest.log('éŸ³é¢‘æµ‹è¯•é¡µé¢å·²åŠ è½½');
            audioTest.log(`å½“å‰æµè§ˆå™¨: ${navigator.userAgent}`);
            audioTest.log(`è¯­éŸ³åˆæˆæ”¯æŒ: ${'speechSynthesis' in window ? 'æ˜¯' : 'å¦'}`);

            if ('speechSynthesis' in window) {
                // ç­‰å¾…è¯­éŸ³åˆ—è¡¨åŠ è½½
                setTimeout(() => {
                    const voices = speechSynthesis.getVoices();
                    const englishVoices = voices.filter(voice => voice.lang.startsWith('en'));
                    audioTest.log(`å¯ç”¨è¯­éŸ³æ•°é‡: ${voices.length}`);
                    audioTest.log(`è‹±è¯­è¯­éŸ³æ•°é‡: ${englishVoices.length}`);
                }, 500);
            }
        });

        // ç¡®ä¿è¯­éŸ³åˆ—è¡¨å·²åŠ è½½
        if (speechSynthesis && speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = function() {
                const voices = speechSynthesis.getVoices();
                audioTest.log(`è¯­éŸ³åˆ—è¡¨æ›´æ–°ï¼Œå…± ${voices.length} ä¸ªè¯­éŸ³`);
            };
        }
    </script>
</body>
</html>